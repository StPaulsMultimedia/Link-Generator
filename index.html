<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Link Generator Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d4af37">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { width: 100%; max-width: 450px; background: #1e1e1e; padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #333; }
        
        h2 { font-family: 'Cinzel', serif; color: #d4af37; font-size: 18px; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; text-align: center; }
        
        label { display: block; margin-top: 15px; font-size: 10px; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        input, select, textarea { width: 100%; background: #2a2a2a; border: 1px solid #444; color: white; padding: 12px; margin-top: 5px; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        
        .date-toggle { display: flex; background: #2a2a2a; border-radius: 8px; margin-top: 5px; padding: 4px; border: 1px solid #444; }
        .date-toggle input { display: none; }
        .date-toggle label { flex: 1; margin: 0; padding: 8px; text-align: center; cursor: pointer; border-radius: 6px; font-size: 12px; transition: 0.2s; color: #888; }
        .date-toggle input:checked + label { background: #d4af37; color: #000; font-weight: bold; }

        .add-svc-toggle { 
            width: 100%; background: transparent; color: #d4af37; border: 1px solid #d4af37; 
            padding: 10px; border-radius: 8px; cursor: pointer; margin-top: 15px; 
            font-size: 11px; font-weight: bold; text-transform: uppercase; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .preset-section { display: none; background: #181818; padding: 15px; border-radius: 10px; margin-top: 10px; border: 1px solid #333; }
        .preset-section.active { display: block; }

        .btn-save { background: #d4af37; color: #000; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 10px; width: 100%; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .btn-clear-settings { background: transparent; color: #ff5555; border: none; font-size: 9px; text-transform: uppercase; cursor: pointer; font-weight: bold; padding: 5px; opacity: 0.7; }
        .btn-clear-settings:disabled { opacity: 0.2; cursor: not-allowed; }

        .yt-fetch-row { display: flex; gap: 8px; align-items: stretch; margin-top: 5px; }
        .yt-fetch-row input { margin-top: 0; flex: 1; }
        
        .fetch-btn { background: #cc0000; color: white; border: none; padding: 0 20px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px; text-transform: uppercase; transition: 0.2s; min-width: 90px; }
        .fetch-btn:disabled { background: #444; }

        #streamModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #1e1e1e; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid #d4af37; max-height: 80vh; overflow-y: auto; }
        .stream-option { background: #2a2a2a; border: 1px solid #444; padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .stream-option:hover { border-color: #d4af37; background: #333; }
        .close-modal { width: 100%; background: #444; color: #fff; border: none; padding: 10px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 11px; }

        .output-box { background: #000; padding: 15px; border-radius: 8px; margin-top: 25px; border: 1px solid #d4af37; white-space: pre-wrap; font-size: 14px; min-height: 120px; color: #eee; }
        
        .action-row { display: flex; gap: 10px; margin-top: 20px; }
        .copy-btn { flex: 2; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; background: #d4af37; color: #000; font-size: 16px; }
        .reset-btn { flex: 1; padding: 15px; border: 1px solid #444; border-radius: 8px; font-weight: bold; cursor: pointer; background: transparent; color: #888; font-size: 12px; text-transform: uppercase; transition: 0.2s; }
        .reset-btn:hover { background: #ff5555; color: white; border-color: #ff5555; }

        .hidden { display: none !important; }
        .lock-notice { display: flex; align-items: center; gap: 8px; margin-top: 10px; font-size: 11px; color: #888; border-top: 1px solid #333; padding-top: 10px; }
        .lock-notice input { width: auto; margin: 0; cursor: pointer; }
    </style>
</head>
<body>

<div id="streamModal">
    <div class="modal-content">
        <h3 style="font-size: 14px; color: #d4af37; margin-top: 0;">SELECT STREAM</h3>
        <div id="streamList"></div>
        <button class="close-modal" onclick="closeModal()">CANCEL</button>
    </div>
</div>

<div class="container">
    <h2>Link Generator</h2>

    <label>Select Service</label>
    <select id="serviceSelect" onchange="handleServiceChange()">
        <option value="30 HOLY MINS">30 Holy Mins</option>
        <option value="HOUR OF MERCY">Hour of Mercy</option>
        <option value="HOUR OF GRACE">Hour of Grace</option>
    </select>

    <label>Select Date</label>
    <div class="date-toggle">
        <input type="radio" id="dateToday" name="dateChoice" value="today" checked onchange="updatePreview()">
        <label for="dateToday">TODAY</label>
        <input type="radio" id="dateTomorrow" name="dateChoice" value="tomorrow" onchange="updatePreview()">
        <label for="dateTomorrow">TOMORROW</label>
    </div>

    <button class="add-svc-toggle" onclick="toggleAddSection()">⚙ Service & YouTube Settings</button>

    <div class="preset-section" id="addSection">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 12px; color: #d4af37; margin: 0;">YouTube Automation</h3>
            <button class="btn-clear-settings" id="btnClear" onclick="clearYTSettings()">CLEAR</button>
        </div>
        
        <label>YouTube API Key</label>
        <input type="password" id="ytApiKey" placeholder="Enter API Key" oninput="saveYTSettings()" oncopy="return false" oncut="return false">
        
        <label>Channel ID</label>
        <input type="password" id="ytChannelId" placeholder="Enter Channel ID" oninput="saveYTSettings()" oncopy="return false" oncut="return false">
        
        <div class="lock-notice">
            <input type="checkbox" id="ytLock" onchange="saveYTSettings()">
            <label for="ytLock" style="margin:0; text-transform:none; color:#bbb; cursor:pointer;">Lock API & Channel ID (Prevents Clearing)</label>
        </div>

        <div style="height: 20px; border-bottom: 1px solid #333; margin-bottom: 15px;"></div>
        
        <h3 style="font-size: 12px; color: #d4af37; margin-top: 0;">Add New Preset</h3>
        <label>Service Name</label>
        <input type="text" id="customSvcInput" placeholder="e.g. MORNING ROSARY">
        <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px; font-size: 12px; color: #bbb;">
            <input type="checkbox" id="customHasTheme" checked style="width:auto;">
            <span>Show Theme field?</span>
        </div>
        <button class="btn-save" onclick="saveCustomService()">SAVE PRESET</button>
        <div id="customList"></div>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <div style="flex:1;"><label>Start Time</label><input type="text" id="startTime" oninput="updatePreview()"></div>
        <div style="flex:1;"><label>End Time</label><input type="text" id="endTime" oninput="updatePreview()"></div>
    </div>

    <label>Led By</label>
    <input type="text" id="ledBy" placeholder="Enter name of the Person or Group" oninput="updatePreview()">

    <div id="theme-container"><label>Theme</label><input type="text" id="theme" placeholder="Enter Theme" oninput="updatePreview()"></div>

    <label>YouTube Link</label>
    <div class="yt-fetch-row">
        <input type="url" id="ytLink" placeholder="Paste link or fetch" oninput="updatePreview()">
        <button class="fetch-btn" id="fetchBtn" onclick="fetchYouTubeStreams()">FETCH</button>
    </div>

    <label>Preview</label>
    <div class="output-box" id="outputPreview"></div>

    <div class="action-row">
        <button class="reset-btn" onclick="resetFields()">Reset</button>
        <button class="copy-btn" onclick="copyToClipboard()">COPY FOR WHATSAPP</button>
    </div>
</div>

<script>
    const DEFAULT_API_KEY = "";
    const DEFAULT_CHANNEL_ID = "";

    const defaults = {
        "30 HOLY MINS": { start: "8:25 PM", end: "9:00 PM", hasTheme: true },
        "HOUR OF MERCY": { start: "3:00 PM", end: "4:00 PM", hasTheme: false },
        "HOUR OF GRACE": { start: "6:00 PM", end: "7:00 PM", hasTheme: false }
    };

    let customServices = JSON.parse(localStorage.getItem('customServiceData')) || {};

    function init() { renderCustomServices(); loadYTSettings(); handleServiceChange(); }
    function toggleAddSection() { document.getElementById('addSection').classList.toggle('active'); }
    function closeModal() { document.getElementById('streamModal').style.display = 'none'; }
    
    function saveYTSettings() { 
        localStorage.setItem('ytApiKey', document.getElementById('ytApiKey').value); 
        localStorage.setItem('ytChannelId', document.getElementById('ytChannelId').value); 
        localStorage.setItem('ytLocked', document.getElementById('ytLock').checked);
        document.getElementById('btnClear').disabled = document.getElementById('ytLock').checked;
    }
    
    function loadYTSettings() { 
        document.getElementById('ytApiKey').value = localStorage.getItem('ytApiKey') || DEFAULT_API_KEY; 
        document.getElementById('ytChannelId').value = localStorage.getItem('ytChannelId') || DEFAULT_CHANNEL_ID; 
        const isLocked = localStorage.getItem('ytLocked') === 'true';
        document.getElementById('ytLock').checked = isLocked;
        document.getElementById('btnClear').disabled = isLocked;
    }
    
    function clearYTSettings() { 
        if(document.getElementById('ytLock').checked) return;
        if(confirm("Revert to default settings?")) { 
            localStorage.removeItem('ytApiKey'); 
            localStorage.removeItem('ytChannelId'); 
            loadYTSettings(); 
        } 
    }

    async function fetchYouTubeStreams() {
        const apiKey = document.getElementById('ytApiKey').value;
        const channelId = document.getElementById('ytChannelId').value;
        const btn = document.getElementById('fetchBtn');
        if (!apiKey) { alert("API Key Missing."); return; }
        btn.disabled = true; btn.innerText = "...";
        try {
            const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&type=video&key=${apiKey}&maxResults=10&order=date`;
            const response = await fetch(url);
            const data = await response.json();
            const streams = data.items.filter(item => item.snippet.liveBroadcastContent !== 'none');
            if (streams.length > 0) {
                const list = document.getElementById('streamList');
                list.innerHTML = '';
                streams.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'stream-option';
                    div.innerHTML = `<div style="padding:10px;"><div style="font-size:13px; font-weight:600;">${s.snippet.title}</div><div style="font-size:11px; color:#888;">${s.snippet.liveBroadcastContent.toUpperCase()}</div></div>`;
                    div.onclick = () => { document.getElementById('ytLink').value = `https://www.youtube.com/live/${s.id.videoId}`; updatePreview(); closeModal(); };
                    list.appendChild(div);
                });
                document.getElementById('streamModal').style.display = 'flex';
            } else { alert("No streams found."); }
        } catch (e) { alert("Fetch failed."); }
        btn.innerText = "FETCH"; btn.disabled = false;
    }

    function handleServiceChange() {
        const key = document.getElementById('serviceSelect').value;
        const config = defaults[key] || customServices[key];
        if (config) { document.getElementById('startTime').value = config.start; document.getElementById('endTime').value = config.end; document.getElementById('theme-container').className = config.hasTheme ? '' : 'hidden'; }
        updatePreview();
    }

    function saveCustomService() {
        const name = document.getElementById('customSvcInput').value.trim().toUpperCase();
        if (name) {
            customServices[name] = { start: document.getElementById('startTime').value, end: document.getElementById('endTime').value, hasTheme: document.getElementById('customHasTheme').checked };
            localStorage.setItem('customServiceData', JSON.stringify(customServices));
            renderCustomServices(); document.getElementById('serviceSelect').value = name; handleServiceChange(); toggleAddSection();
        }
    }

    function renderCustomServices() {
        const select = document.getElementById('serviceSelect'); const list = document.getElementById('customList');
        select.innerHTML = `<option value="30 HOLY MINS">30 Holy Mins</option><option value="HOUR OF MERCY">Hour of Mercy</option><option value="HOUR OF GRACE">Hour of Grace</option>`;
        list.innerHTML = '';
        Object.keys(customServices).forEach(key => {
            const opt = document.createElement('option'); opt.value = key; opt.innerText = key; select.appendChild(opt);
            const div = document.createElement('div'); div.style = "display:flex; justify-content:space-between; background:#222; padding:8px; border-radius:6px; margin-top:8px; font-size:11px;";
            div.innerHTML = `<span>${key}</span><span style="color:#ff5555; cursor:pointer;" onclick="deleteSvc('${key}')">×</span>`;
            list.appendChild(div);
        });
    }

    function deleteSvc(key) { if(confirm(`Delete ${key}?`)) { delete customServices[key]; localStorage.setItem('customServiceData', JSON.stringify(customServices)); renderCustomServices(); handleServiceChange(); } }

    function updatePreview() {
        const service = document.getElementById('serviceSelect').value;
        const start = document.getElementById('startTime').value || "[Time]";
        const end = document.getElementById('endTime').value || "[Time]";
        const ledBy = document.getElementById('ledBy').value || "[Name]";
        const theme = document.getElementById('theme').value;
        const ytLink = document.getElementById('ytLink').value || "[Link]";
        let targetDate = new Date();
        if (document.getElementById('dateTomorrow').checked) { targetDate.setDate(targetDate.getDate() + 1); }
        const dateStr = targetDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        const config = defaults[service] || customServices[service];
        let template = `*${service}*\n${dateStr}  | ${start} to ${end}\n\nLed by: *${ledBy}*\n\n`;
        if (config && config.hasTheme && theme) { template += `Theme: *${theme}*\n\n`; }
        template += `${ytLink}\n\n*St Pauls Multimedia*`;
        document.getElementById('outputPreview').innerText = template;
    }

    function resetFields() { if(confirm("Reset form?")) { document.getElementById('ledBy').value = ''; document.getElementById('theme').value = ''; document.getElementById('ytLink').value = ''; document.getElementById('dateToday').checked = true; handleServiceChange(); } }

    function copyToClipboard() {
        navigator.clipboard.writeText(document.getElementById('outputPreview').innerText).then(() => {
            const btn = document.querySelector('.copy-btn'); btn.innerText = "COPIED! ✅"; setTimeout(() => btn.innerText = "COPY FOR WHATSAPP", 2000);
        });
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(reg => console.log('PWA Ready')).catch(err => console.log('PWA Failed', err));
        });
    }

    window.onload = init;
</script>
</body>
</html>